---
import { AstroSeo } from "@astrolib/seo";
import { GoogleAnalytics } from "@astrolib/analytics";
import { getImage } from "astro:assets";

import { SITE } from "~/config.mjs";
import { MetaSEO } from "~/types";
import { getCanonical, getAsset } from "~/utils/permalinks";
import { getRelativeUrlByFilePath } from "~/utils/directories";

import CustomStyles from "~/components/CustomStyles.astro";

export interface Props extends MetaSEO {
  dontUseTitleTemplate?: boolean;
}

// Resolve defaultImage to an absolute URL if provided. Avoid calling getImage on unknown values.
const defaultImage = SITE.defaultImage ? new URL(SITE.defaultImage, SITE.origin).toString() : "";

const {
  title = SITE.name,
  description = "",
  image: _image = defaultImage,

  canonical = getCanonical(String(Astro.url.pathname)),
  noindex = false,
  nofollow = false,

  ogTitle = title,
  ogType = "website",

  dontUseTitleTemplate = false,
} = Astro.props;

let imageUrl: string | null = null;
if (typeof _image === "string" && _image.length > 0) {
  try {
    imageUrl = new URL(_image, Astro.site).toString();
  } catch (e) {
    imageUrl = null;
  }
} else if (_image && typeof _image["src"] !== "undefined") {
  // _image is likely an imported ImageMetadata object
  // @ts-ignore
  imageUrl = new URL(getRelativeUrlByFilePath(_image.src), Astro.site).toString();
}
---

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<AstroSeo
  title={title}
  titleTemplate={dontUseTitleTemplate ? "%s" : `%s â€” ${SITE.name}`}
  description={description}
  canonical={String(canonical)}
  noindex={noindex}
  nofollow={nofollow}
  openGraph={{
    url: String(canonical),
    title: ogTitle,
    description: description,
    type: ogType,
    images: imageUrl
      ? [
          {
            url: imageUrl,
            alt: ogTitle,
          },
        ]
      : undefined,
    // site_name: 'SiteName',
  }}
  twitter={{
    handle: "@theroks",
    // site: '@site',
    cardType: imageUrl ? "summary_large_image" : undefined,
  }}
/>

<CustomStyles />

<!-- Google Site Verification -->
{SITE.googleSiteVerificationId && <meta name="google-site-verification" content={SITE.googleSiteVerificationId} />}

<!-- Google Analytics -->
{SITE.googleAnalyticsId && <GoogleAnalytics id={String(SITE.googleAnalyticsId)} partytown={true} />}

<!-- {SITE.splitbeeAnalytics?.enabled && <SplitbeeAnalytics {...SITE.splitbeeAnalytics} />} -->

<link rel="shortcut icon" href={getAsset("/icon.png")} />
<link rel="icon" type="image/svg+xml" href={getAsset("/icon.png")} />
<link rel="mask-icon" href={getAsset("/icon.png")} color="#8D46E7" />
<script
  defer
  src="https://static.cloudflareinsights.com/beacon.min.js"
  data-cf-beacon='{"token": "3a97b7004e184fb3864600759db69a73"}'></script>
